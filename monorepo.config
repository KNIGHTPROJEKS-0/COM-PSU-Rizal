# ============================================================================
# COM-PSU-Rizal Monorepo Configuration
# ============================================================================
# This configuration file defines paths, settings, and environment variables
# for the monorepo build and run automation script.
# ============================================================================

# Project structure configuration
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WEBAPP_DIR="$PROJECT_ROOT/apps/webapp"
DESKTOP_DIR="$PROJECT_ROOT/apps/desktop"
PACKAGES_DIR="$PROJECT_ROOT/packages"
SERVICES_DIR="$PROJECT_ROOT/services"
SCRIPTS_DIR="$PROJECT_ROOT/scripts"
INTEGRATIONS_DIR="$PROJECT_ROOT/integrations"

# Port configuration
WEBAPP_PORT=3001
ELECTRON_PORT=3002
PYTHON_API_PORT=8001

# Build configuration
NODE_ENV="${NODE_ENV:-development}"
BUILD_MODE="${BUILD_MODE:-development}"
PARALLEL_JOBS="${PARALLEL_JOBS:-$(nproc 2>/dev/null || echo 4)}"

# Environment variables for different services
WEBAPP_ENV_VARS=(
    "NODE_ENV=$NODE_ENV"
    "NEXT_PUBLIC_APP_ENV=$NODE_ENV"
    "NEXT_PUBLIC_API_URL=http://localhost:$PYTHON_API_PORT"
    "NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_URL:-}"
    "NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY:-}"
)

ELECTRON_ENV_VARS=(
    "NODE_ENV=$NODE_ENV"
    "ELECTRON_IS_DEV=true"
    "MAIN_WINDOW_URL=http://localhost:$WEBAPP_PORT"
    "API_URL=http://localhost:$PYTHON_API_PORT"
)

PYTHON_ENV_VARS=(
    "PYTHONPATH=$SERVICES_DIR/python"
    "API_PORT=$PYTHON_API_PORT"
    "DATABASE_URL=${DATABASE_URL:-}"
    "REDIS_URL=${REDIS_URL:-redis://localhost:6379}"
)

# Dependency management
WEBAPP_DEPENDENCIES=(
    "@com-psu-rizal/shared-components"
    "@com-psu-rizal/shared-lib"
    "next"
    "react"
    "react-dom"
    "tailwindcss"
    "framer-motion"
)

ELECTRON_DEPENDENCIES=(
    "electron"
    "electron-builder"
    "concurrently"
    "wait-on"
    "@com-psu-rizal/shared-components"
    "@com-psu-rizal/shared-lib"
)

PYTHON_DEPENDENCIES=(
    "fastapi"
    "uvicorn"
    "pydantic"
    "starlette"
    "httpx"
    "python-multipart"
)

# Build commands
WEBAPP_BUILD_CMD="npm run build"
WEBAPP_DEV_CMD="npm run dev"
WEBAPP_START_CMD="npm run start"

ELECTRON_BUILD_CMD="npm run package"
ELECTRON_DEV_CMD="npm run dev"
ELECTRON_START_CMD="npm run start"

PYTHON_BUILD_CMD="pip install -r requirements.txt"
PYTHON_DEV_CMD="python main.py"
PYTHON_START_CMD="python main.py"

# Health check endpoints
WEBAPP_HEALTH_URL="http://localhost:$WEBAPP_PORT"
PYTHON_HEALTH_URL="http://localhost:$PYTHON_API_PORT/docs"
ELECTRON_HEALTH_CHECK="pgrep -f electron"

# File paths for cleanup
BUILD_ARTIFACTS=(
    "$WEBAPP_DIR/.next"
    "$WEBAPP_DIR/out"
    "$DESKTOP_DIR/dist"
    "$DESKTOP_DIR/build"
    "$SERVICES_DIR/python/__pycache__"
    "$SERVICES_DIR/python/**/*.pyc"
)

# Log files
LOG_DIR="$PROJECT_ROOT/logs"
WEBAPP_LOG="$LOG_DIR/webapp.log"
ELECTRON_LOG="$LOG_DIR/electron.log"
PYTHON_LOG="$LOG_DIR/python.log"
BUILD_LOG="$LOG_DIR/build.log"

# Process ID files
PID_DIR="$PROJECT_ROOT/.pids"
WEBAPP_PID_FILE="$PID_DIR/webapp.pid"
ELECTRON_PID_FILE="$PID_DIR/electron.pid"
PYTHON_PID_FILE="$PID_DIR/python.pid"

# Docker configuration (if using Docker)
DOCKER_COMPOSE_FILE="$PROJECT_ROOT/docker-compose.yml"
DOCKER_WEBAPP_SERVICE="webapp"
DOCKER_ELECTRON_SERVICE="electron"
DOCKER_PYTHON_SERVICE="python-api"

# Cross-platform compatibility
case "$(uname -s)" in
    Darwin)
        OS="macos"
        ;;
    Linux)
        OS="linux"
        ;;
    CYGWIN*|MINGW32*|MSYS*|MINGW*)
        OS="windows"
        ;;
    *)
        OS="unknown"
        ;;
esac

# Node.js version requirements
REQUIRED_NODE_VERSION="18.0.0"
REQUIRED_PYTHON_VERSION="3.8.0"

# Package manager detection
if command -v yarn >/dev/null 2>&1; then
    PACKAGE_MANAGER="yarn"
elif command -v pnpm >/dev/null 2>&1; then
    PACKAGE_MANAGER="pnpm"
else
    PACKAGE_MANAGER="npm"
fi

# Export all variables for use in scripts
export PROJECT_ROOT WEBAPP_DIR DESKTOP_DIR PACKAGES_DIR SERVICES_DIR SCRIPTS_DIR
export WEBAPP_PORT ELECTRON_PORT PYTHON_API_PORT
export NODE_ENV BUILD_MODE PARALLEL_JOBS
export OS PACKAGE_MANAGER
export LOG_DIR PID_DIR